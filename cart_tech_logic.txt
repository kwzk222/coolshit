CART TECH LOGIC DOCUMENTATION

The Cart Tech module (TNT Minecart Tech) is a multi-stage state machine that automates the placement of rails, TNT minecarts, and a follow-up combat sequence (Lava/Crossbow or Bow).

1. INTERCEPTION OF RAIL PLACEMENT
The sequence begins when the player interacts with a block while holding a rail. This is intercepted in the ClientPlayerInteractionManagerMixin:

@Inject(method = "interactBlock", at = @At("TAIL"))
private void onInteractBlock(ClientPlayerEntity player, Hand hand, BlockHitResult hitResult, CallbackInfoReturnable<ActionResult> cir) {
    if (TutorialMod.CONFIG.tntMinecartPlacementEnabled && cir.getReturnValue().isAccepted()) {
        ItemStack stack = player.getStackInHand(hand);
        if (stack.getItem() instanceof BlockItem && ((BlockItem) stack.getItem()).getBlock() instanceof AbstractRailBlock) {
            TutorialModClient.setAwaitingRailConfirmation();
        }
    }
}

The 'setAwaitingRailConfirmation()' method sets a short cooldown (2 ticks) to wait for the server to confirm the rail placement.

2. RAIL PLACEMENT CONFIRMATION
The mod listens for block updates from the server. If a rail block appears at the position the player just interacted with, Phase 1 concludes:

// In ClientPlayNetworkHandlerMixin
@Inject(method = "onBlockUpdate", at = @At("TAIL"))
private void onBlockUpdate(BlockUpdateS2CPacket packet, CallbackInfo info) {
    TutorialModClient.confirmRailPlacement(packet.getPos(), packet.getState());
    // ... (other confirmations)
}

// In TutorialModClient
public static void confirmRailPlacement(BlockPos pos, BlockState state) {
    if (awaitingRailConfirmationCooldown > 0 && state.getBlock() instanceof net.minecraft.block.AbstractRailBlock) {
        if (instance != null) instance.startRailPlacement(pos);
        awaitingRailConfirmationCooldown = -1;
    }
}

'startRailPlacement' then initializes the TNT Minecart placement state:

public void startRailPlacement(BlockPos pos) {
    if (placementCooldown != -1) return;
    MinecraftClient client = MinecraftClient.getInstance();
    if (client.player == null || findTntMinecartInHotbar(client.player) == -1) return;
    this.railPos = pos;
    this.placementCooldown = 1;
    this.nextPlacementAction = PlacementAction.PLACE_TNT_MINECART;
}

3. TNT MINECART PLACEMENT
In the next client tick, 'handlePlacementSequence' executes the 'PLACE_TNT_MINECART' action. To satisfy 1.21.x interaction semantics, it hits the rail's horizontal face (NORTH) with a valid Y-offset and swings the hand:

case PLACE_TNT_MINECART:
    int minecartSlot = findTntMinecartInHotbar(client.player);
    if (minecartSlot != -1) {
        inventory.setSelectedSlot(minecartSlot);
        if (railPos != null) {
            BlockHitResult bhr = new BlockHitResult(
                    new Vec3d(railPos.getX() + 0.5, railPos.getY() + 0.6, railPos.getZ() + 0.5),
                    Direction.NORTH, railPos, false
            );
            client.player.swingHand(Hand.MAIN_HAND);
            client.interactionManager.interactBlock(client.player, Hand.MAIN_HAND, bhr);
        } else {
            client.player.swingHand(Hand.MAIN_HAND);
            client.interactionManager.interactItem(client.player, Hand.MAIN_HAND);
        }
        awaitingMinecartConfirmationCooldown = 20; // Wait for server confirmation
    }
    // railPos is NOT cleared here; it persists until confirmation or timeout
    break;

4. POST-PLACEMENT DETECTION
The mod then waits for the server to spawn the TNT Minecart entity. When detected within a 5-block radius, the final combat sequence is triggered:

// In ClientPlayNetworkHandlerMixin
@Inject(method = "onEntitySpawn", at = @At("TAIL"))
private void onEntitySpawn(EntitySpawnS2CPacket packet, CallbackInfo ci) {
    if (TutorialModClient.awaitingMinecartConfirmationCooldown > 0) {
        MinecraftClient client = MinecraftClient.getInstance();
        if (client.player != null) {
            if (packet.getEntityType() == net.minecraft.entity.EntityType.TNT_MINECART) {
                double distSq = client.player.squaredDistanceTo(packet.getX(), packet.getY(), packet.getZ());
                if (distSq <= 25.0) {
                    TutorialModClient.getInstance().startPostMinecartSequence(client);
                    TutorialModClient.awaitingMinecartConfirmationCooldown = -1;
                }
            }
        }
    }
}

5. FINAL COMBAT SEQUENCE
'startPostMinecartSequence' clears the context and handles the transition to a weapon. It prioritizes a Lava/Crossbow combo if enabled and available, otherwise it switches to a Bow:

public void startPostMinecartSequence(MinecraftClient client) {
    if (client.player == null) return;
    this.railPos = null; // Clear context on success
    PlayerInventoryMixin inventory = (PlayerInventoryMixin) client.player.getInventory();
    if (TutorialMod.CONFIG.lavaCrossbowSequenceEnabled) {
        // ... (sequence logic)
    }
}

6. TIMEOUT HANDLING
If the server does not confirm the minecart placement within 20 ticks, the context is automatically cleared in 'handleConfirmationCooldowns':

if (awaitingMinecartConfirmationCooldown > 0) {
    awaitingMinecartConfirmationCooldown--;
    if (awaitingMinecartConfirmationCooldown == 0) {
        railPos = null;
    }
}
