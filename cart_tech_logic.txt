CART TECH LOGIC DOCUMENTATION

The Cart Tech module (TNT Minecart Tech) is a multi-stage state machine that automates the placement of rails, TNT minecarts, and a follow-up combat sequence (Lava/Crossbow or Bow).

1. INTERCEPTION OF RAIL PLACEMENT
The sequence begins when the player interacts with a block while holding a rail. This is intercepted in the ClientPlayerInteractionManagerMixin:

@Inject(method = "interactBlock", at = @At("TAIL"))
private void onInteractBlock(ClientPlayerEntity player, Hand hand, BlockHitResult hitResult, CallbackInfoReturnable<ActionResult> cir) {
    if (TutorialMod.CONFIG.tntMinecartPlacementEnabled && cir.getReturnValue().isAccepted()) {
        ItemStack stack = player.getStackInHand(hand);
        if (stack.getItem() instanceof BlockItem && ((BlockItem) stack.getItem()).getBlock() instanceof AbstractRailBlock) {
            TutorialModClient.setAwaitingRailConfirmation();
        }
    }
}

The 'setAwaitingRailConfirmation()' method sets a short cooldown (2 ticks) to wait for the server to confirm the rail placement.

2. RAIL PLACEMENT CONFIRMATION
The mod listens for block updates from the server. If a rail block appears at the position the player just interacted with, Phase 1 concludes:

// In ClientPlayNetworkHandlerMixin
@Inject(method = "onBlockUpdate", at = @At("TAIL"))
private void onBlockUpdate(BlockUpdateS2CPacket packet, CallbackInfo info) {
    TutorialModClient.confirmRailPlacement(packet.getPos(), packet.getState());
    // ... (other confirmations)
}

// In TutorialModClient
public static void confirmRailPlacement(BlockPos pos, BlockState state) {
    if (awaitingRailConfirmationCooldown > 0 && state.getBlock() instanceof net.minecraft.block.AbstractRailBlock) {
        if (instance != null) instance.startRailPlacement(pos);
        awaitingRailConfirmationCooldown = -1;
    }
}

'startRailPlacement' then initializes the TNT Minecart placement state:

public void startRailPlacement(BlockPos pos) {
    if (placementCooldown != -1) return;
    MinecraftClient client = MinecraftClient.getInstance();
    if (client.player == null || findTntMinecartInHotbar(client.player) == -1) return;
    this.railPos = pos;
    this.placementCooldown = 1;
    this.nextPlacementAction = PlacementAction.PLACE_TNT_MINECART;
}

3. TNT MINECART PLACEMENT
In the next client tick, 'handlePlacementSequence' executes the 'PLACE_TNT_MINECART' action. It uses 'interactBlock' targeting the specific rail position to ensure the minecart is placed correctly on the rail:

case PLACE_TNT_MINECART:
    int minecartSlot = findTntMinecartInHotbar(client.player);
    if (minecartSlot != -1) {
        inventory.setSelectedSlot(minecartSlot);
        if (railPos != null) {
            BlockHitResult bhr = new BlockHitResult(
                    new Vec3d(railPos.getX() + 0.5, railPos.getY() + 0.0625, railPos.getZ() + 0.5),
                    Direction.UP, railPos, false
            );
            client.interactionManager.interactBlock(client.player, Hand.MAIN_HAND, bhr);
        } else {
            client.interactionManager.interactItem(client.player, Hand.MAIN_HAND);
        }
        awaitingMinecartConfirmationCooldown = 10; // Wait for server confirmation
    }
    railPos = null; // Clear railPos after attempting placement
    break;

4. POST-PLACEMENT DETECTION
The mod then waits for the server to spawn the TNT Minecart entity. When detected within a 5-block radius, the final combat sequence is triggered:

// In ClientPlayNetworkHandlerMixin
@Inject(method = "onEntitySpawn", at = @At("TAIL"))
private void onEntitySpawn(EntitySpawnS2CPacket packet, CallbackInfo ci) {
    if (TutorialModClient.awaitingMinecartConfirmationCooldown > 0) {
        MinecraftClient client = MinecraftClient.getInstance();
        if (client.player != null) {
            if (packet.getEntityType() == net.minecraft.entity.EntityType.TNT_MINECART) {
                double distSq = client.player.squaredDistanceTo(packet.getX(), packet.getY(), packet.getZ());
                if (distSq <= 25.0) {
                    TutorialModClient.getInstance().startPostMinecartSequence(client);
                    TutorialModClient.awaitingMinecartConfirmationCooldown = -1;
                }
            }
        }
    }
}

5. FINAL COMBAT SEQUENCE
'startPostMinecartSequence' handles the transition to a weapon. It prioritizes a Lava/Crossbow combo if enabled and available, otherwise it switches to a Bow:

public void startPostMinecartSequence(MinecraftClient client) {
    if (client.player == null) return;
    PlayerInventoryMixin inventory = (PlayerInventoryMixin) client.player.getInventory();
    if (TutorialMod.CONFIG.lavaCrossbowSequenceEnabled) {
        int crossSlot = findLoadedCrossbowInHotbar(client.player);
        if (crossSlot != -1) {
            int lavaSlot = findLavaBucketInHotbar(client.player);
            if (lavaSlot != -1) {
                this.utilitySlot = lavaSlot;
                this.crossbowSlot = crossSlot;
                inventory.setSelectedSlot(lavaSlot);
                this.actionTimeout = 60;
                this.placementCooldown = 1;
                this.nextPlacementAction = PlacementAction.AWAITING_LAVA_PLACEMENT;
                return;
            }
            int flintSlot = findFlintAndSteelInHotbar(client.player);
            if (flintSlot != -1) {
                this.utilitySlot = flintSlot;
                this.crossbowSlot = crossSlot;
                inventory.setSelectedSlot(flintSlot);
                this.actionTimeout = 60;
                this.placementCooldown = 1;
                this.nextPlacementAction = PlacementAction.AWAITING_FIRE_PLACEMENT;
                return;
            }
        }
    }
    if (TutorialMod.CONFIG.bowSequenceEnabled) {
        long currentTime = client.world.getTime();
        if (lastBowShotTick == -1 || (currentTime - lastBowShotTick) > TutorialMod.CONFIG.bowCooldown) {
            int bowSlot = findBowInHotbar(client.player);
            if (bowSlot != -1) {
                inventory.setSelectedSlot(bowSlot);
            }
        }
    }
}

If the Lava combo is chosen, the mod waits for the server to confirm the Lava/Fire placement before finally switching to the Crossbow:

// Final transition after Lava/Fire is confirmed
case SWITCH_TO_CROSSBOW:
    inventory.setSelectedSlot(crossbowSlot);
    utilitySlot = -1;
    crossbowSlot = -1;
    break;
