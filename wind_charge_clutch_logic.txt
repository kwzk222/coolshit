WIND CHARGE CLUTCH LOGIC DOCUMENTATION

The Wind Charge Clutch is integrated into the unified state machine of the ClutchModule. It uses an accelerated predictive algorithm to time the release of a wind charge, ensuring the player receives upward knockback just before impact to negate fall damage.

1. ACTIVATION AND PRE-ARMING
The module monitors the player's fall state. If water clutching is unavailable or the conditions are met for wind charges, the state machine transitions to WIND_PREARMED:

// In IDLE state
else if (config.windClutchEnabled && p.fallDistance >= config.windClutchMinFallDistance) {
    int slot = findWindChargeSlot();
    if (slot != -1) {
        originalSlot = ((PlayerInventoryMixin) p.getInventory()).getSelectedSlot();
        armedSlot = slot;
        setSlot(slot);
        fireAttempts = 0;
        vyBeforeFire = 0.0;
        successTickCounter = 0;
        state = ClutchState.WIND_PREARMED;
    }
}

2. ACCELERATED PREDICTIVE TIMING (TICKS-TO-IMPACT)
In the WIND_PREARMED state, the mod calculates how many ticks remain before the player hits the ground. To avoid quantization errors at specific heights, the estimator accounts for gravitational acceleration (0.08 per tick) using midpoint velocity extrapolation:

private double estimateTicksToImpact(net.minecraft.entity.player.PlayerEntity p) {
    double reach = 256.0;
    HitResult hr = p.raycast(reach, 1.0f, false);
    double vy = p.getVelocity().y;
    double g = 0.08; // gravity per tick
    double effectiveVy = -vy + g; // next-tick velocity extrapolation

    if (hr == null || hr.getType() != HitResult.Type.BLOCK) {
        double distance = p.getY();
        if (vy >= -0.01) return Double.POSITIVE_INFINITY;
        return distance / effectiveVy;
    } else {
        BlockHitResult bhr = (BlockHitResult) hr;
        double distance = p.getY() - bhr.getPos().y;
        if (vy >= -0.01) return Double.POSITIVE_INFINITY;
        return Math.max(0.0, distance / effectiveVy);
    }
}

3. DYNAMIC FIRE THRESHOLD AND EARLY-FIRE GUARD
The fire timing is adjusted based on fall height. Crucially, the mod implements a deterministic early-fire guard that subtracts 1.0 tick from the estimate when falling fast (vy < -1.5). This aligns client-side firing with the server's damage resolution phase:

case WIND_PREARMED -> {
    if (p.isOnGround()) { reset(); return; }
    if (p.getVelocity().y < -3.8) { reset(); return; } // Abort if too fast (terminal)

    double ticksToImpact = estimateTicksToImpact(p);

    // FIRE ONE TICK EARLIER when falling fast to align with server damage resolution
    if (p.getVelocity().y < -1.5) {
        ticksToImpact -= 1.0;
    }

    int fireTicks = p.fallDistance > 114 ? config.windClutchHighFallFireTicks : config.windClutchFireTicks;
    if (ticksToImpact <= fireTicks) {
        state = ClutchState.WIND_READY_TO_FIRE;
    }
}

4. FIRING SEQUENCE
Once within the threshold, the mod switches to the WIND_READY_TO_FIRE state and immediately invokes the item use pipeline:

case WIND_READY_TO_FIRE -> {
    if (p.isOnGround()) { reset(); return; }
    doWindFireAttempt();
    state = ClutchState.WIND_FIRED;
    vyBeforeFire = p.getVelocity().y;
    successTickCounter = 0;
}

private void doWindFireAttempt() {
    if (mc.player == null) return;
    if (((PlayerInventoryMixin) mc.player.getInventory()).getSelectedSlot() != armedSlot) {
        setSlot(armedSlot);
    }
    ((MinecraftClientAccessor) mc).setItemUseCooldown(0);
    ((MinecraftClientAccessor) mc).invokeDoItemUse();
    fireAttempts++;
}

5. SUCCESS VERIFICATION AND RETRIES
After firing, the mod monitors the player's vertical velocity and fall distance. A successful clutch is detected by a significant upward change in velocity (knockback) or a reset of the fall distance counter.

case WIND_FIRED -> {
    successTickCounter++;
    double vyNow = p.getVelocity().y;
    boolean velocitySuccess = (vyNow - vyBeforeFire) >= config.windClutchSuccessVyDelta;
    boolean fallDistanceReset = p.fallDistance < Math.max(1.0, config.windClutchMinFallDistance / 2.0);

    if (velocitySuccess || fallDistanceReset) {
        state = ClutchState.FINISHING;
        tickCounter = 0;
        return;
    }

    // Retry logic with accelerated estimation
    if (fireAttempts < config.windClutchMaxRetries && p.getVelocity().y < -0.08 && successTickCounter >= 1) {
        double ticksToImpact = estimateTicksToImpact(p);
        if (ticksToImpact > 0.5) {
            doWindFireAttempt();
            vyBeforeFire = p.getVelocity().y;
            successTickCounter = 0;
        }
    }

    if (successTickCounter > 8) { reset(); return; }
}

6. CLEANUP
Once success is confirmed, the machine enters the FINISHING state to restore the player's original hotbar slot after a configurable delay.
